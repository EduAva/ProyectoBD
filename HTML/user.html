<?php
session_start();
// 1. Verificar seguridad
if (!isset($_SESSION['email_usu'])) {
    header("Location: Login.html");
    exit();
}

// 2. Conexión a Base de Datos
$host = 'localhost';
$dbname = 'garritasfelices';
$user = 'postgres';
$pass = '1234';

try {
    $pdo = new PDO("pgsql:host=$host;port=5432;dbname=$dbname;", $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $email = $_SESSION['email_usu'];

    // 3. Obtener Usuario
    $stmtUser = $pdo->prepare("SELECT id_usuario, nombre_usu, apellido_pa_usu, tel_usu, email_usu FROM usuarios WHERE email_usu = :email");
    $stmtUser->execute(['email' => $email]);
    $usuario = $stmtUser->fetch(PDO::FETCH_ASSOC);

    if (!$usuario) {
        session_destroy();
        header("Location: Login.html");
        exit();
    }
    
    $id_usuario = $usuario['id_usuario'];

    // 4. Obtener Mascotas
    // Asegúrate que en tu BD la columna sea 'id_dueno' (si es diferente, cámbialo aquí)
    $stmtMascotas = $pdo->prepare("SELECT * FROM Mascota WHERE id_usuario_fk = :id");    
    $stmtMascotas->execute(['id' => $id_usuario]);
    $mis_mascotas = $stmtMascotas->fetchAll(PDO::FETCH_ASSOC);

    // 5. Obtener Reservaciones
    // CORREGIDO: Usamos los nombres reales de tu base de datos
    $stmtReservas = $pdo->prepare("SELECT * FROM reservaciones WHERE id_usuario_fk = :id ORDER BY fecha_entrada DESC");
    $stmtReservas->execute(['id' => $id_usuario]);
    $mis_reservas = $stmtReservas->fetchAll(PDO::FETCH_ASSOC);

} catch (PDOException $e) {
    die("Error de conexión: " . $e->getMessage());
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Garritas Felices</title>
    <link rel="stylesheet" href="../CSS/user.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <nav class="barra-nav">
        <ul class="barra-link">
            <li><a href="../HTML/Pagina-Principal.html" class="barra-link-estilo">Inicio</a></li>
            <li><a href="Registro-Mascota.html" class="barra-link-estilo">Registro de Mascotas</a></li>
            <li><a href="Servicios.html" class="barra-link-estilo">Servicios</a></li>
            <li><a href="contacto.html" class="barra-link-estilo">Contáctanos</a></li>
            <li><a href="user.php" class="barra-link-estilo" style="background-color: #F9A66C; color: white;">Mi Cuenta</a></li>
        </ul>
    </nav>

    <div class="contenedor-dashboard">
        
        <aside class="sidebar-usuario" id="tarjeta-usuario">
            <div class="tarjeta-usuario">
                <h2 id="nombre-usuario">
                    <?php echo htmlspecialchars($usuario['nombre_usu'] . ' ' . $usuario['apellido_pa_usu']); ?>
                </h2>
                <p class="email-usuario"><?php echo htmlspecialchars($usuario['email_usu']); ?></p>
                <p class="telefono-usuario"><?php echo htmlspecialchars($usuario['tel_usu']); ?></p>
                
                <hr>
                <button class="btn-logout" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
            </div>
        </aside>

        <main class="contenido-principal">

            <section class="seccion-dashboard">
                <div class="encabezado-mascotas">
                    <h2 class="titulo-seccion"><i class="fas fa-paw"></i> Mis Mascotas</h2>
                    <a href="Registro-Mascota.html" class="btn-agregar"><i class="fas fa-plus"></i> Nueva</a>
                </div>

                <div class="grid-mascotas">
                    <?php if (count($mis_mascotas) > 0): ?>
                        <?php foreach ($mis_mascotas as $mascota): ?>
                            <div class="tarjeta-mascota">
                                <div class="img-mascota" style="background-image: url('../IMG/huella.png'); background-color: #ddd;"></div>
                                <div class="info-mascota">
                                    <h3><?php echo htmlspecialchars($mascota['nombre_mascota']); ?></h3>
                                    <p><?php echo htmlspecialchars($mascota['especie'] . ' - ' . $mascota['raza']); ?></p>
                                    <p class="texto-pequeno"><?php echo htmlspecialchars($mascota['edad']); ?> años</p>
                                    <button class="btn-cartilla">Ver Cartilla</button>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    <?php else: ?>
                        <p style="grid-column: 1/-1; text-align: center;">No tienes mascotas registradas aún.</p>
                    <?php endif; ?>
                </div>
            </section>

            <section class="seccion-dashboard">
                <h2 class="titulo-seccion"><i class="fas fa-history"></i> Historial de Reservaciones</h2>
                <table class="tabla-historial">
                    <thead>
                        <tr>
                            <th>Entrada</th>
                            <th>Salida</th>
                            <th>Habitacion</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php if (count($mis_reservas) > 0): ?>
                            <?php foreach ($mis_reservas as $reserva): ?>
                                <tr>
                                    <td><?php echo htmlspecialchars($reserva['fecha_entrada']); ?></td>
                                    
                                    <td><?php echo htmlspecialchars($reserva['fecha_salida']); ?></td>
                                    
                                    <td><?php echo htmlspecialchars($reserva['tipo_habitacion'] ?? 'Estándar'); ?></td>
                                    
                                    <td>
                                        <span class="etiqueta-estado">
                                            <?php echo htmlspecialchars($reserva['estado_reservacion']); ?>
                                        </span>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <tr>
                                <td colspan="4" style="text-align:center;">No hay reservaciones registradas.</td>
                            </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </section>

        </main>
    </div>

    <script>
        function cerrarSesion() {
            // Asegúrate que logout.php esté en la carpeta PHP
            fetch('../PHP/logout.php')
                .then(() => {
                    window.location.href = '../HTML/Pagina-Principal.html';
                })
                .catch(error => console.error('Error al cerrar sesión: ', error));
        }
    </script>
</body>
</html>
